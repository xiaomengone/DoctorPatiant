import{d as E,c as r,r as V,L as K,M as D,N as j,m as Q,E as W}from"./index-17af02c9.js";import{c as Y,A as N,o as Z,n as ee,C as ae,I as F,D as M,E as le,e as C,m as O,d as k,t as U,f as te,x as ne,G as re,h as R,w as ie}from"./index-c960a1ea.js";import{L as oe,u as se}from"./request-5b5d1fad.js";import{s as ce}from"./index-32ed2876.js";import{I as ue}from"./index-4863e674.js";import{c as de}from"./use-route-e2d195f8.js";const[fe,i,ve]=Y("uploader");function B(e,t){return new Promise(o=>{if(t==="file"){o();return}const c=new FileReader;c.onload=v=>{o(v.target.result)},t==="dataUrl"?c.readAsDataURL(e):t==="text"&&c.readAsText(e)})}function T(e,t){return N(e).some(o=>o.file?Z(t)?t(o.file):o.file.size>+t:!1)}function me(e,t){const o=[],c=[];return e.forEach(v=>{T(v,t)?c.push(v):o.push(v)}),{valid:o,invalid:c}}const ge=/\.(jpeg|jpg|gif|png|svg|webp|jfif|bmp|dpg|avif)/i,we=e=>ge.test(e);function G(e){return e.isImage?!0:e.file&&e.file.type?e.file.type.indexOf("image")===0:e.url?we(e.url):typeof e.content=="string"?e.content.indexOf("data:image")===0:!1}var pe=E({props:{name:ee,item:ae(Object),index:Number,imageFit:String,lazyLoad:Boolean,deletable:Boolean,reupload:Boolean,previewSize:[Number,String,Array],beforeDelete:Function},emits:["delete","preview","reupload"],setup(e,{emit:t,slots:o}){const c=()=>{const{status:n,message:u}=e.item;if(n==="uploading"||n==="failed"){const p=n==="failed"?r(F,{name:"close",class:i("mask-icon")},null):r(oe,{class:i("loading")},null),f=le(u)&&u!=="";return r("div",{class:i("mask")},[p,f&&r("div",{class:i("mask-message")},[u])])}},v=n=>{const{name:u,item:p,index:f,beforeDelete:P}=e;n.stopPropagation(),de(P,{args:[p,{name:u,index:f}],done:()=>t("delete")})},w=()=>t("preview"),m=()=>t("reupload"),h=()=>{if(e.deletable&&e.item.status!=="uploading"){const n=o["preview-delete"];return r("div",{role:"button",class:i("preview-delete",{shadow:!n}),tabindex:0,"aria-label":ve("delete"),onClick:v},[n?n():r(F,{name:"cross",class:i("preview-delete-icon")},null)])}},y=()=>{if(o["preview-cover"]){const{index:n,item:u}=e;return r("div",{class:i("preview-cover")},[o["preview-cover"](C({index:n},u))])}},I=()=>{const{item:n,lazyLoad:u,imageFit:p,previewSize:f,reupload:P}=e;return G(n)?r(ue,{fit:p,src:n.objectUrl||n.content||n.url,class:i("preview-image"),width:Array.isArray(f)?f[0]:f,height:Array.isArray(f)?f[1]:f,lazyLoad:u,onClick:P?m:w},{default:y}):r("div",{class:i("file"),style:M(e.previewSize)},[r(F,{class:i("file-icon"),name:"description"},null),r("div",{class:[i("file-name"),"van-ellipsis"]},[n.file?n.file.name:n.url]),y()])};return()=>r("div",{class:i("preview")},[I(),c(),h()])}});const be={name:O(""),accept:k("image/*"),capture:String,multiple:Boolean,disabled:Boolean,readonly:Boolean,lazyLoad:Boolean,maxCount:O(1/0),imageFit:k("cover"),resultType:k("dataUrl"),uploadIcon:k("photograph"),uploadText:String,deletable:U,reupload:Boolean,afterRead:Function,showUpload:U,modelValue:te(),beforeRead:Function,beforeDelete:Function,previewSize:[Number,String,Array],previewImage:U,previewOptions:Object,previewFullImage:U,maxSize:{type:[Number,String,Function],default:1/0}};var he=E({name:fe,props:be,emits:["delete","oversize","clickUpload","closePreview","clickPreview","clickReupload","update:modelValue"],setup(e,{emit:t,slots:o}){const c=V(),v=[],w=V(-1),m=(a=e.modelValue.length)=>({name:e.name,index:a}),h=()=>{c.value&&(c.value.value="")},y=a=>{if(h(),T(a,e.maxSize))if(Array.isArray(a)){const l=me(a,e.maxSize);if(a=l.valid,t("oversize",l.invalid,m()),!a.length)return}else{t("oversize",a,m());return}if(a=W(a),w.value>-1){const l=[...e.modelValue];l.splice(w.value,1,a),t("update:modelValue",l),w.value=-1}else t("update:modelValue",[...e.modelValue,...N(a)]);e.afterRead&&e.afterRead(a,m())},I=a=>{const{maxCount:l,modelValue:d,resultType:s}=e;if(Array.isArray(a)){const g=+l-d.length;a.length>g&&(a=a.slice(0,g)),Promise.all(a.map(b=>B(b,s))).then(b=>{const J=a.map((L,A)=>{const S={file:L,status:"",message:"",objectUrl:URL.createObjectURL(L)};return b[A]&&(S.content=b[A]),S});y(J)})}else B(a,s).then(g=>{const b={file:a,status:"",message:"",objectUrl:URL.createObjectURL(a)};g&&(b.content=g),y(b)})},n=a=>{const{files:l}=a.target;if(e.disabled||!l||!l.length)return;const d=l.length===1?l[0]:[].slice.call(l);if(e.beforeRead){const s=e.beforeRead(d,m());if(!s){h();return}if(re(s)){s.then(g=>{I(g||d)}).catch(h);return}}I(d)};let u;const p=()=>t("closePreview"),f=a=>{if(e.previewFullImage){const l=e.modelValue.filter(G),d=l.map(s=>(s.objectUrl&&!s.url&&s.status!=="failed"&&(s.url=s.objectUrl,v.push(s.url)),s.url)).filter(Boolean);u=ce(C({images:d,startPosition:l.indexOf(a),onClose:p},e.previewOptions))}},P=()=>{u&&u.close()},_=(a,l)=>{const d=e.modelValue.slice(0);d.splice(l,1),t("update:modelValue",d),t("delete",a,m(l))},q=a=>{z(),w.value=a},X=(a,l)=>{const d=["imageFit","deletable","reupload","previewSize","beforeDelete"],s=C(R(e,d),R(a,d,!0));return r(pe,Q({item:a,index:l,onClick:()=>t(e.reupload?"clickReupload":"clickPreview",a,m(l)),onDelete:()=>_(a,l),onPreview:()=>f(a),onReupload:()=>q(l)},R(e,["name","lazyLoad"]),s),R(o,["preview-cover","preview-delete"]))},$=()=>{if(e.previewImage)return e.modelValue.map(X)},x=a=>t("clickUpload",a),H=()=>{if(e.modelValue.length>=+e.maxCount&&!e.reupload)return;const a=e.modelValue.length>=+e.maxCount&&e.reupload,l=e.readonly?null:r("input",{ref:c,type:"file",class:i("input"),accept:e.accept,capture:e.capture,multiple:e.multiple&&w.value===-1,disabled:e.disabled,onChange:n},null);return o.default?D(r("div",{class:i("input-wrapper"),onClick:x},[o.default(),l]),[[j,!a]]):D(r("div",{class:i("upload",{readonly:e.readonly}),style:M(e.previewSize),onClick:x},[r(F,{name:e.uploadIcon,class:i("upload-icon")},null),e.uploadText&&r("span",{class:i("upload-text")},[e.uploadText]),l]),[[j,e.showUpload&&!a]])},z=()=>{c.value&&!e.disabled&&c.value.click()};return K(()=>{v.forEach(a=>URL.revokeObjectURL(a))}),se({chooseFile:z,closeImagePreview:P}),ne(()=>e.modelValue),()=>r("div",{class:i()},[r("div",{class:i("wrapper",{disabled:e.disabled})},[$(),H()])])}});const Fe=ie(he);export{Fe as U};
